{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} - {{ course.title }} | Abruisdev{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/lesson.css' %}">
{% endblock %}

{% block content %}
<!-- Mobile Sidebar Overlay -->
<div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

<div class="lesson-page">
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="lesson-breadcrumb">
            <a href="/">
                <i class="fas fa-home"></i>
                <span>Bosh sahifa</span>
            </a>
            <span>/</span>
            <a href="/course/">Kurslar</a>
            <span>/</span>
            <a href="{% url 'course_detail' course.id %}">{{ course.title|truncatewords:3 }}</a>
            <span>/</span>
            <span class="current">{{ lesson.title|truncatewords:4 }}</span>
        </nav>

        <div class="lesson-content-wrapper">
            <!-- Main Content -->
            <main class="lesson-main">
                <!-- Video Player -->
                <div class="video-container">
                    <div class="video-wrapper">
                        {% if is_free_lesson or is_enrolled %}
                            {% if lesson.video_file %}
                                <video
                                    id="lessonVideo"
                                    controls
                                    controlsList="nodownload"
                                    playsinline
                                    webkit-playsinline>
                                    <source src="{{ lesson.video_file.url }}" type="video/mp4">
                                    Brauzeringiz video formatini qo'llab-quvvatlamaydi.
                                </video>
                            {% else %}
                                <div class="video-empty">
                                    <div class="video-empty-content">
                                        <i class="fas fa-video-slash"></i>
                                        <p>Video hali yuklanmagan</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- Locked Video -->
                            <div class="video-locked">
                                <div class="lock-content">
                                    <div class="lock-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <h2 class="lock-title">Premium dars</h2>
                                    <p class="lock-text">
                                        Bu darsni ko'rish uchun kursni sotib olishingiz kerak
                                    </p>
                                    <a href="https://t.me/abruisdev" target="_blank" class="btn-telegram-lock">
                                        <i class="fab fa-telegram"></i>
                                        Telegram orqali murojaat
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Lesson Info -->
                <div class="lesson-info-card">
                    <h1>{{ lesson.title }}</h1>
                    <div class="lesson-meta">
                        <div class="lesson-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>{{ lesson.duration_formatted|default:"15 daqiqa" }}</span>
                        </div>
                        <div class="lesson-meta-item">
                            <i class="fas fa-list-ol"></i>
                            <span>{{ lesson.order }}-dars</span>
                        </div>
                        {% if lesson.is_free %}
                        <div class="lesson-meta-item">
                            <i class="fas fa-gift"></i>
                            <span>Bepul</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </main>

            <!-- Sidebar - Lessons List -->
            <aside class="lesson-sidebar" id="lessonSidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">
                            <i class="fas fa-list"></i>
                            Kurs Darslari
                        </h3>
                        <button class="sidebar-close" id="sidebarClose" aria-label="Yopish">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="lessons-list">
                        {% for les in other_lessons %}
                            <a href="{% url 'lesson_view' course.id les.id %}"
                               class="lesson-item {% if les.id == lesson.id %}active{% endif %}">
                                <div class="lesson-item-info">
                                    <span class="lesson-number">{{ les.order }}</span>
                                    <span class="lesson-item-title">{{ les.title }}</span>
                                </div>
                                <span class="lesson-status">
                                    {% if les.is_free %}
                                        <i class="fas fa-unlock" title="Bepul"></i>
                                    {% elif is_enrolled %}
                                        <i class="fas fa-play-circle" title="Ko'rish"></i>
                                    {% else %}
                                        <i class="fas fa-lock" title="Premium"></i>
                                    {% endif %}
                                </span>
                            </a>
                        {% empty %}
                            <div class="lessons-empty">
                                <i class="fas fa-inbox"></i>
                                <p>Darslar mavjud emas</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Mobile Sidebar Toggle Button -->
<button class="mobile-sidebar-toggle" id="mobileSidebarToggle" aria-label="Darslar ro'yxati">
    <i class="fas fa-list-ul"></i>
    {% if other_lessons %}
        <span class="badge">{{ other_lessons|length }}</span>
    {% endif %}
</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const sidebar = document.getElementById('lessonSidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    const toggleBtn = document.getElementById('mobileSidebarToggle');
    const closeBtn = document.getElementById('sidebarClose');
    const video = document.getElementById('lessonVideo');

    // Toggle Sidebar
    function toggleSidebar() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
    }

    // Close Sidebar
    function closeSidebar() {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Event Listeners
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleSidebar);
    }

    if (closeBtn) {
        closeBtn.addEventListener('click', closeSidebar);
    }

    if (overlay) {
        overlay.addEventListener('click', closeSidebar);
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && sidebar.classList.contains('active')) {
            closeSidebar();
        }
    });

    // Video Player Enhancements
    if (video) {
        const lessonId = '{{ lesson.id }}';
        const storageKey = 'lesson_' + lessonId + '_progress';

        // Restore video progress
        const savedTime = localStorage.getItem(storageKey);
        if (savedTime) {
            video.currentTime = parseFloat(savedTime);
        }

        // Save video progress (throttled)
        let saveTimeout;
        video.addEventListener('timeupdate', function() {
            if (saveTimeout) return;
            saveTimeout = setTimeout(function() {
                localStorage.setItem(storageKey, video.currentTime);
                saveTimeout = null;
            }, 1000);
        });

        // Clear progress when video ends
        video.addEventListener('ended', function() {
            localStorage.removeItem(storageKey);
        });
    }

    // Close sidebar when clicking on a lesson link (mobile)
    const lessonLinks = document.querySelectorAll('.lesson-item');
    lessonLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 900) {
                closeSidebar();
            }
        });
    });

    // Handle resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (window.innerWidth > 900) {
                closeSidebar();
            }
        }, 100);
    });
});
</script>
{% endblock %}